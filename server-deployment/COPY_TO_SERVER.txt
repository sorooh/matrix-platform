========================================
انسخ هذا السكريبت والصقه في التيرمنال على السيرفر
========================================

bash -c "$(curl -fsSL https://raw.githubusercontent.com/sorooh/matrix-platform/master/server-deployment/setup-and-fix.sh)" || bash << 'ENDOFSCRIPT'
#!/bin/bash
set -e
echo "Setting up Matrix Platform..."

# Create directories
mkdir -p /opt/matrix-platform/server-deployment
mkdir -p /opt/matrix-platform/matrix-scaffold/backend
mkdir -p /var/log/matrix-platform

# Clone project
cd /opt
if [ ! -d "matrix-platform/.git" ]; then
    git clone https://github.com/sorooh/matrix-platform.git matrix-platform || echo "Clone failed, continuing..."
fi
cd matrix-platform

# Start services
systemctl start postgresql redis-server nginx 2>/dev/null || true
systemctl enable postgresql redis-server nginx 2>/dev/null || true

# Setup database
sudo -u postgres psql << EOF 2>/dev/null || true
CREATE DATABASE matrix;
CREATE USER matrix WITH ENCRYPTED PASSWORD 'matrix_password_2025';
GRANT ALL PRIVILEGES ON DATABASE matrix TO matrix;
\c matrix
GRANT ALL ON SCHEMA public TO matrix;
CREATE EXTENSION IF NOT EXISTS vector;
\q
EOF

# Build application
cd matrix-scaffold/backend
export DATABASE_URL="postgresql://matrix:matrix_password_2025@localhost:5432/matrix"
export REDIS_URL="redis://localhost:6379"
export NODE_ENV="production"

npm ci --production --quiet 2>&1 | grep -v "npm WARN" || true
npx prisma migrate deploy --quiet || true
npx prisma generate --quiet
npm run build --quiet

# Install PM2 if needed
command -v pm2 || npm install -g pm2

# Create PM2 config
cd /opt/matrix-platform
cat > pm2.ecosystem.config.js << 'PM2EOF'
module.exports = {
  apps: [{
    name: 'matrix-platform',
    script: './matrix-scaffold/backend/dist/main.js',
    cwd: '/opt/matrix-platform',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000,
      DATABASE_URL: 'postgresql://matrix:matrix_password_2025@localhost:5432/matrix',
      REDIS_URL: 'redis://localhost:6379',
      VERSION: '11.0.0'
    },
    autorestart: true,
    max_memory_restart: '1G'
  }]
};
PM2EOF

# Start PM2
pm2 delete matrix-platform 2>/dev/null || true
pm2 start pm2.ecosystem.config.js
pm2 save
pm2 startup systemd -u root --hp /root 2>/dev/null || true

# Setup nginx
cat > /etc/nginx/sites-available/senorbit.ai << 'NGINXEOF'
server {
    listen 80;
    server_name senorbit.ai www.senorbit.ai;
    return 301 https://$server_name$request_uri;
}
server {
    listen 443 ssl http2;
    server_name senorbit.ai www.senorbit.ai;
    ssl_certificate /etc/letsencrypt/live/senorbit.ai/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/senorbit.ai/privkey.pem;
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
NGINXEOF

ln -sf /etc/nginx/sites-available/senorbit.ai /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t && systemctl reload nginx

# Setup SSL if needed
[ ! -f "/etc/letsencrypt/live/senorbit.ai/fullchain.pem" ] && \
certbot --nginx -d senorbit.ai -d www.senorbit.ai --non-interactive --agree-tos --email admin@senorbit.ai --redirect --quiet 2>/dev/null || true

echo "✅ Setup complete!"
echo "Test: curl https://senorbit.ai/health"
ENDOFSCRIPT

