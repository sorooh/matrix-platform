// Prisma Schema for Matrix Platform
// Global-Ready Architecture with PostgreSQL + pgvector

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enable pgvector extension
// Run: CREATE EXTENSION IF NOT EXISTS vector;

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  userId      String?  // For multi-tenancy
  region      String?  @default("us-east-1")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  jobs        Job[]
  tasks       Task[]
  memories    Memory[]
  artifacts   Artifact[]

  @@index([userId])
  @@index([region])
  @@map("projects")
}

model Job {
  id        String   @id @default(uuid())
  projectId String
  status    String   @default("pending") // pending | running | completed | failed
  spec      Json     // JobSpec
  result    Json?    // Job result
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  artifacts Artifact[]

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@map("jobs")
}

model Task {
  id        String   @id @default(uuid())
  projectId String
  type      String   // analysis | architecture | coding | testing | visual
  status    String   @default("queued") // queued | in_progress | completed | failed
  payload   Json?
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type, status])
  @@index([createdAt])
  @@map("tasks")
}

model Memory {
  id        String   @id @default(uuid())
  projectId String   @default("__org__") // "__org__" for org memory
  text      String   @db.Text
  vector    Unsupported("vector(256)")? // pgvector - 256 dimensions
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
  @@map("memory")
}

model Artifact {
  id        String   @id @default(uuid())
  jobId     String
  projectId String
  type      String   // png | html | thumb | log | generic
  path      String?
  url       String?  // CDN URL
  meta      Json?
  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  job     Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([projectId])
  @@index([type])
  @@map("artifacts")
}

model Bot {
  id        String   @id @default(uuid())
  name      String
  role      String   // morpheus | architect | sida | vision | audit
  status    String   @default("active") // active | inactive
  createdAt DateTime @default(now())

  @@index([role])
  @@index([status])
  @@map("bots")
}

model GraphEdge {
  id        String   @id @default(uuid())
  fromType  String   // Org | Project | Task | Job | Artifact | Memory
  fromId    String
  toType    String   // Org | Project | Task | Job | Artifact | Memory
  toId      String
  rel       String   // Relationship type
  createdAt DateTime @default(now())

  @@index([fromType, fromId])
  @@index([toType, toId])
  @@index([rel])
  @@map("graph_edges")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  resource  String
  ip        String?
  userAgent String?
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}

model KpiSnapshot {
  id        String   @id @default(uuid())
  ts        DateTime @default(now())
  kpis      Json     // KPI data
  region    String   @default("us-east-1")

  @@index([ts])
  @@index([region])
  @@map("kpi_snapshots")
}

// Phase 4: Smart User Accounts
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  name              String?
  avatar            String?
  password          String?   // Hashed password
  role              String   @default("user") // user | admin | enterprise
  emailVerified     Boolean  @default(false)
  verificationToken String?
  verificationExpires DateTime?
  twoFactorEnabled  Boolean  @default(false)
  twoFactorSecret   String?
  oauthProvider     String?  // google | github | microsoft
  oauthId           String?
  preferences       Json?    // Theme, language, notifications
  metadata          Json?
  lastLoginAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  sessions          UserSession[]
  activities        UserActivity[]
  projects          Project[]
  memories          UserMemory[]
  referrals         Referral[] @relation("Referrer")
  referredBy        Referral? @relation("ReferredUser")
  points            UserPoints?
  subscriptions     Subscription[]
  billingHistory    BillingHistory[]
  notifications     Notification[]
  companionAgent    CompanionAgent?

  @@index([email])
  @@index([role])
  @@index([emailVerified])
  @@index([oauthProvider, oauthId])
  @@map("users")
}

model UserSession {
  id            String   @id @default(uuid())
  userId        String
  token         String   // Hashed token
  ip            String?
  userAgent     String?
  expiresAt     DateTime
  lastActivityAt DateTime @default(now())
  createdAt     DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}

model UserActivity {
  id          String   @id @default(uuid())
  userId      String
  type        String   // login | logout | action | api_call | error
  description String
  metadata    Json?
  timestamp   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([timestamp])
  @@map("user_activities")
}

// Phase 4: Personal AI Memory
model UserMemory {
  id        String   @id @default(uuid())
  userId    String
  text      String   @db.Text
  vector    Unsupported("vector(256)")? // pgvector - 256 dimensions
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("user_memories")
}

// Phase 4: Referral & Reward System
model Referral {
  id            String   @id @default(uuid())
  referrerId    String   // User who referred
  referredUserId String? // User who was referred
  token         String   @unique // Unique referral token
  status        String   @default("pending") // pending | completed | rewarded
  pointsEarned  Int      @default(0)
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  // Relations
  referrer      User     @relation("Referrer", fields: [referrerId], references: [id])
  referredUser User?    @relation("ReferredUser", fields: [referredUserId], references: [id])

  @@index([referrerId])
  @@index([referredUserId])
  @@index([token])
  @@index([status])
  @@map("referrals")
}

model UserPoints {
  id            String   @id @default(uuid())
  userId        String   @unique
  totalPoints   Int      @default(0)
  aiCredits     Int      @default(0)
  tier          String   @default("bronze") // bronze | silver | gold | diamond
  referralsCount Int     @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tier])
  @@map("user_points")
}

// Phase 4: Billing & Subscriptions
model Subscription {
  id                String   @id @default(uuid())
  userId            String
  tier              String   // free | pro | enterprise | custom
  status            String   @default("active") // active | cancelled | expired | suspended | trial
  paymentProvider    String   // stripe | paypal | crypto
  paymentMethodId   String?
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean  @default(false)
  trialEnd          DateTime?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices          Invoice[]
  usageMetrics      UsageMetrics[]
  apiKeys           APIKey[]
  instances         PrivateInstance[]
  licenses          License[]

  @@index([userId])
  @@index([status])
  @@index([tier])
  @@map("subscriptions")
}

model BillingHistory {
  id            String   @id @default(uuid())
  userId        String
  type          String   // subscription | purchase | refund
  amount        Float
  currency      String   @default("USD")
  status        String   // pending | completed | failed
  paymentMethod String?  // stripe | paypal | crypto
  transactionId String?
  metadata      Json?
  createdAt     DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("billing_history")
}

// Phase 4: Advanced Notifications
model Notification {
  id          String   @id @default(uuid())
  userId      String
  type        String   // info | warning | error | success | system
  title       String
  message     String   @db.Text
  read        Boolean  @default(false)
  actionUrl   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  readAt      DateTime?

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

// Phase 4: Personal Companion AI
model CompanionAgent {
  id            String   @id @default(uuid())
  userId        String   @unique
  name          String   @default("My Companion")
  personality   Json?    // AI personality traits
  memory        Json?    // Learned preferences
  stats         Json?    // Usage statistics
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([enabled])
  @@map("companion_agents")
}

// Phase 8: AI Rental & Commercial Deployment

model Invoice {
  id              String   @id @default(uuid())
  subscriptionId  String
  userId          String
  amount          Float
  currency        String   @default("USD")
  status          String   @default("draft") // draft | open | paid | void | uncollectible
  periodStart     DateTime
  periodEnd       DateTime
  items           Json     // InvoiceItem[]
  paymentProvider String   // stripe | paypal | crypto
  paymentIntentId String?
  paidAt          DateTime?
  dueDate         DateTime
  createdAt       DateTime @default(now())

  // Relations
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("invoices")
}

model UsageMetrics {
  id              String       @id @default(uuid())
  subscriptionId  String
  periodStart     DateTime
  periodEnd       DateTime
  requests        Int          @default(0)
  tokens          Int          @default(0)
  cost            Float        @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, periodStart])
  @@index([subscriptionId])
  @@index([periodStart])
  @@map("usage_metrics")
}

model APIKey {
  id              String   @id @default(uuid())
  userId          String
  subscriptionId  String?
  key             String   @unique
  name            String
  status          String   @default("active") // active | revoked | expired | suspended
  rateLimit       Json     // RateLimit
  usage           Json     // UsageStats
  allowedAIs      String[] // AI IDs that can be accessed
  metadata        Json?
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime?
  expiresAt       DateTime?

  // Relations
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([key])
  @@map("api_keys")
}

model AIListing {
  id              String   @id @default(uuid())
  name            String
  description     String   @db.Text
  type            String   // nicholas | surooh | lida | bot | model | custom
  capabilities    String[]
  price           Json     // Pricing
  usageCapacity   Json     // UsageCapacity
  status          String   @default("available") // available | purchased | subscribed | private
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  purchases       Purchase[]
  reviews         Review[]

  @@index([type])
  @@index([status])
  @@map("ai_listings")
}

model Purchase {
  id              String   @id @default(uuid())
  userId          String
  aiId            String
  pricingModel    String   // instant | monthly | custom | private
  subscriptionId  String?
  instanceId      String?
  amount          Float
  currency        String   @default("USD")
  status          String   @default("pending") // pending | completed | failed | cancelled
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  // Relations
  listing         AIListing @relation(fields: [aiId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([aiId])
  @@index([status])
  @@index([createdAt])
  @@map("purchases")
}

model Review {
  id              String   @id @default(uuid())
  aiId            String
  userId          String
  rating          Int      // 1-5
  title           String
  content         String   @db.Text
  verified        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  listing         AIListing @relation(fields: [aiId], references: [id], onDelete: Cascade)

  @@index([aiId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

model PrivateInstance {
  id              String   @id @default(uuid())
  userId          String
  subscriptionId String
  name            String
  type            String   // nicholas | surooh | lida | bot | model | custom
  status          String   @default("active") // active | suspended | expired | deleted
  resources       Json     // InstanceResources
  performance     Json     // InstancePerformance
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  expiresAt       DateTime?

  // Relations
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@map("private_instances")
}

model License {
  id              String   @id @default(uuid())
  userId          String
  subscriptionId  String?
  aiId            String
  type            String   // personal | commercial | reseller | custom
  status          String   @default("active") // active | expired | revoked | suspended
  terms           Json     // LicenseTerms
  metadata        Json?
  issuedAt        DateTime @default(now())
  expiresAt       DateTime?
  revokedAt       DateTime?

  // Relations
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subscriptionId])
  @@index([aiId])
  @@index([status])
  @@map("licenses")
}

model ComplianceCheck {
  id              String   @id @default(uuid())
  userId          String
  subscriptionId String?
  status          String   // compliant | non_compliant | pending
  checks          Json     // ComplianceCheckItem[]
  passed          Boolean
  checkedAt       DateTime @default(now())

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([checkedAt])
  @@map("compliance_checks")
}

model UsageReport {
  id              String   @id @default(uuid())
  userId          String
  subscriptionId String?
  period          String   // daily | weekly | monthly | custom
  periodStart     DateTime
  periodEnd       DateTime
  summary         Json     // UsageSummary
  details         Json     // UsageDetail[]
  generatedAt     DateTime @default(now())

  @@index([userId])
  @@index([subscriptionId])
  @@index([period])
  @@index([generatedAt])
  @@map("usage_reports")
}

model InvoiceReport {
  id              String   @id @default(uuid())
  userId          String
  periodStart     DateTime
  periodEnd       DateTime
  summary         Json     // InvoiceSummary
  invoices        String[] // Invoice IDs
  generatedAt     DateTime @default(now())

  @@index([userId])
  @@index([generatedAt])
  @@map("invoice_reports")
}

// Phase 8.1: AI Rental Dashboard & Client Panel

model ClientProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  email           String
  name            String
  language        String   @default("en") // en | ar
  timezone        String?
  preferences     Json     // ClientPreferences
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([email])
  @@map("client_profiles")
}

model ClientSession {
  id              String   @id @default(uuid())
  userId          String
  token           String   @unique
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())
  expiresAt       DateTime
  lastActivityAt  DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("client_sessions")
}

model Ticket {
  id              String   @id @default(uuid())
  userId          String
  type            String   // issue | question | feature_request | billing | technical
  priority        String   @default("medium") // low | medium | high | urgent
  status          String   @default("open") // open | in_progress | resolved | closed
  subject         String
  description     String   @db.Text
  messages        Json     // TicketMessage[]
  assignedTo     String?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  resolvedAt      DateTime?
  closedAt        DateTime?

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("tickets")
}

model ClientNotification {
  id              String   @id @default(uuid())
  userId          String
  type            String   // billing | usage | system | support
  channel         String   @default("in_app") // in_app | email | telegram | discord
  status          String   @default("unread") // unread | read | archived
  title           String
  message         String   @db.Text
  actionUrl       String?
  metadata        Json?
  createdAt       DateTime @default(now())
  readAt          DateTime?
  archivedAt      DateTime?

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([channel])
  @@index([createdAt])
  @@map("client_notifications")
}

model TwoFactorAuth {
  id              String   @id @default(uuid())
  userId          String   @unique
  enabled         Boolean  @default(false)
  secret          String?
  backupCodes     String[]
  createdAt       DateTime @default(now())
  verifiedAt      DateTime?

  @@index([userId])
  @@map("two_factor_auth")
}

// Phase 8.4: Developer Marketplace & AI Runtime

model Developer {
  id                String   @id @default(uuid())
  userId            String   @unique
  email             String
  name              String
  company           String?
  status            String   @default("pending") // pending | verified | suspended | rejected
  verificationLevel String   @default("email") // email | kyc | full
  tier              String   @default("free") // free | pro | enterprise
  walletId          String   @unique
  profile           Json     // DeveloperProfile
  portfolio         Json     // DeveloperPortfolio
  kycData           Json?    // KYCData
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  apps              App[]
  wallet            DeveloperWallet?
  withdrawals       Withdrawal[]

  @@index([userId])
  @@index([status])
  @@index([verificationLevel])
  @@map("developers")
}

model App {
  id              String   @id @default(uuid())
  developerId     String
  name            String
  slug            String   @unique
  description     String   @db.Text
  longDescription String?  @db.Text
  category        String
  tags            String[]
  version         String   @default("1.0.0")
  status          String   @default("draft") // draft | pending | reviewing | approved | rejected | published | suspended
  accessLevel     String   @default("private") // public | private | premium | enterprise
  licenseType     String   @default("closed_source") // open_source | closed_source | commercial | custom
  pricing         Json     // Pricing
  sourceCode      String?  @db.Text
  repository      String?
  icon            String?
  screenshots     String[]
  video           String?
  documentation  String?  @db.Text
  requirements    String[]
  features        String[]
  changelog       String?  @db.Text
  licenseKey      String?
  usageTokens     Int?
  totalDownloads Int      @default(0)
  totalRevenue    Float    @default(0)
  rating          Float    @default(0)
  reviews         Int      @default(0)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  // Relations
  developer       Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)
  versions        AppVersion[]
  installations   AppInstallation[]
  appReviews      AppReview[]
  revenueShares   RevenueShare[]
  scanResults     CodeScanResult[]

  @@index([developerId])
  @@index([status])
  @@index([category])
  @@index([slug])
  @@map("apps")
}

model AppVersion {
  id              String   @id @default(uuid())
  appId           String
  version         String
  status          String   @default("draft") // draft | published | deprecated | archived
  compatibility   String   @default("backward_compatible") // backward_compatible | breaking | major | minor | patch
  changelog       String?  @db.Text
  sourceCode      String   @db.Text
  runtimeConfig   Json?
  apiTokens       String[]
  endpoints       String[]
  isStable        Boolean  @default(false)
  isDefault        Boolean  @default(false)
  createdAt       DateTime @default(now())
  publishedAt     DateTime?
  deprecatedAt    DateTime?

  // Relations
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  appTokens       AppToken[]

  @@unique([appId, version])
  @@index([appId])
  @@index([status])
  @@map("app_versions")
}

model AppToken {
  id                String   @id @default(uuid())
  appId             String
  version           String
  token             String   @unique
  name              String
  permissions       String[]
  rateLimit         Json     // RateLimit
  isActive          Boolean  @default(true)
  expiresAt         DateTime?
  createdAt         DateTime @default(now())

  // Relations
  appVersion        AppVersion @relation(fields: [appId, version], references: [appId, version], onDelete: Cascade)

  @@index([appId])
  @@index([token])
  @@index([isActive])
  @@map("app_tokens")
}

model AppInstance {
  id              String   @id @default(uuid())
  appId           String
  developerId     String
  version         String
  status          String   @default("pending") // pending | running | stopped | error
  containerId     String?
  runtimeConfig   Json     // RuntimeConfig
  resourceUsage   Json     // ResourceUsage
  endpoint        String   @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  metrics         RuntimeMetrics[]

  @@index([appId])
  @@index([developerId])
  @@index([status])
  @@map("app_instances")
}

model RuntimeMetrics {
  id              String   @id @default(uuid())
  instanceId     String
  cpu             Float
  memory          Float
  storage         Float
  requests        Int      @default(0)
  errors          Int      @default(0)
  latency         Float
  uptime          Int
  timestamp       DateTime @default(now())

  // Relations
  instance       AppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([timestamp])
  @@map("runtime_metrics")
}

model DeveloperWallet {
  id              String   @id @default(uuid())
  developerId     String   @unique
  balance         Float    @default(0)
  currency        String   @default("USD")
  pendingBalance  Float    @default(0)
  totalEarned     Float    @default(0)
  totalWithdrawn  Float    @default(0)
  lastUpdated     DateTime @default(now())

  // Relations
  developer       Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)

  @@index([developerId])
  @@map("developer_wallets")
}

model RevenueShare {
  id                String   @id @default(uuid())
  transactionId     String
  appId             String
  developerId       String
  userId            String
  amount            Float
  currency          String   @default("USD")
  developerShare    Float
  platformShare     Float
  developerPercentage Float
  platformPercentage Float
  type              String   // subscription | one_time | usage | commission
  status            String   @default("pending") // pending | processing | completed | failed
  processedAt       DateTime?
  metadata          Json?
  createdAt         DateTime @default(now())

  // Relations
  app               App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([developerId])
  @@index([status])
  @@index([createdAt])
  @@map("revenue_shares")
}

model Withdrawal {
  id              String   @id @default(uuid())
  developerId     String
  amount          Float
  currency        String   @default("USD")
  walletAddress   String?
  bankAccount     String?
  paymentMethod   String   // crypto | bank | paypal | stripe
  status          String   @default("pending") // pending | processing | completed | failed
  processedAt     DateTime?
  transactionHash String?
  createdAt       DateTime @default(now())

  // Relations
  developer       Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)

  @@index([developerId])
  @@index([status])
  @@index([createdAt])
  @@map("withdrawals")
}

model CodeScanResult {
  id              String   @id @default(uuid())
  appId           String
  version         String
  status          String   @default("pending") // pending | scanning | completed | failed
  riskLevel       String   @default("low") // low | medium | high | critical
  issues          Json     // ScanIssue[]
  score           Int      // 0-100
  metadata        Json?
  scannedAt       DateTime @default(now())

  // Relations
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([version])
  @@index([riskLevel])
  @@map("code_scan_results")
}

model SecurityAudit {
  id              String   @id @default(uuid())
  appId           String
  developerId     String
  action          String   // publish | update | delete | approve | reject
  scanResultId    String?
  riskLevel       String   @default("low") // low | medium | high | critical
  approved        Boolean  @default(false)
  approvedBy      String?
  notes           String?  @db.Text
  createdAt       DateTime @default(now())

  @@index([appId])
  @@index([developerId])
  @@index([action])
  @@index([createdAt])
  @@map("security_audits")
}

model AppReview {
  id              String   @id @default(uuid())
  appId           String
  userId          String
  rating          Int      // 1-5
  title           String?
  comment         String?  @db.Text
  status          String   @default("pending") // pending | approved | rejected
  helpful         Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([userId])
  @@index([status])
  @@index([rating])
  @@map("app_reviews")
}

model AppInstallation {
  id              String   @id @default(uuid())
  appId           String
  userId          String
  version         String
  instanceId      String?
  status          String   @default("installed") // installed | running | stopped | uninstalled
  installedAt     DateTime @default(now())
  lastUsedAt      DateTime?

  // Relations
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([userId])
  @@index([status])
  @@map("app_installations")
}

// Phase 8.2: Partner & Reseller Portal

model Partner {
  id              String   @id @default(uuid())
  name            String
  email           String
  subdomain       String   @unique
  domain          String?
  logo            String?
  theme           Json?    // PartnerTheme
  status          String   @default("pending") // active | suspended | pending | inactive
  tier            String   @default("bronze") // bronze | silver | gold | platinum
  commissionRate  Float    @default(10)
  customPricing   Json?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  members         PartnerMember[]
  resellers       Reseller[]
  commissions     Commission[]
  payouts         Payout[]
  oauthClients    PartnerOAuthClient[]
  brandConfig     BrandConfig?
  auditLogs       PartnerAuditLog[]

  @@index([status])
  @@index([tier])
  @@index([subdomain])
  @@map("partners")
}

model PartnerMember {
  id              String   @id @default(uuid())
  partnerId       String
  userId          String
  role            String   // owner | manager | sales | support | viewer
  email           String
  name            String
  permissions     String[]
  createdAt       DateTime @default(now())

  // Relations
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([userId])
  @@map("partner_members")
}

model Reseller {
  id              String   @id @default(uuid())
  partnerId       String
  name            String
  email           String
  status          String   @default("pending") // active | suspended | pending | inactive
  commissionRate  Float    @default(5)
  customPricing   Json?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  customers      ResellerCustomer[]
  commissions    Commission[]

  @@index([partnerId])
  @@index([status])
  @@map("resellers")
}

model ResellerCustomer {
  id              String   @id @default(uuid())
  resellerId      String
  userId          String
  email           String
  name            String
  subscriptionId String?
  createdAt       DateTime @default(now())

  // Relations
  reseller        Reseller @relation(fields: [resellerId], references: [id], onDelete: Cascade)

  @@index([resellerId])
  @@index([userId])
  @@map("reseller_customers")
}

model Commission {
  id              String   @id @default(uuid())
  partnerId       String
  resellerId      String?
  type            String   // sale | subscription | recurring
  amount          Float
  currency        String   @default("USD")
  percentage      Float
  saleAmount      Float
  status          String   @default("pending") // pending | processing | completed | failed
  payoutId        String?
  saleId          String?
  subscriptionId  String?
  metadata        Json?
  createdAt       DateTime @default(now())
  paidAt          DateTime?

  // Relations
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  reseller        Reseller? @relation(fields: [resellerId], references: [id], onDelete: SetNull)
  payout          Payout?   @relation(fields: [payoutId], references: [id], onDelete: SetNull)

  @@index([partnerId])
  @@index([resellerId])
  @@index([status])
  @@index([payoutId])
  @@index([createdAt])
  @@map("commissions")
}

model Payout {
  id              String   @id @default(uuid())
  partnerId       String
  amount          Float
  currency        String   @default("USD")
  status          String   @default("pending") // pending | processing | completed | failed
  paymentProvider String   // stripe | paypal
  paymentMethodId String
  commissions     String[] // Commission IDs
  scheduledAt     DateTime
  processedAt     DateTime?
  metadata        Json?
  createdAt       DateTime @default(now())

  // Relations
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  commissionList  Commission[]

  @@index([partnerId])
  @@index([status])
  @@index([scheduledAt])
  @@map("payouts")
}

model PartnerOAuthClient {
  id              String   @id @default(uuid())
  partnerId       String
  clientId        String   @unique
  clientSecret    String
  redirectUris    String[]
  scopes          String[]
  rateLimit       Json     // RateLimit
  createdAt       DateTime @default(now())

  // Relations
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([clientId])
  @@map("partner_oauth_clients")
}

model BrandConfig {
  id              String   @id @default(uuid())
  partnerId       String   @unique
  brandName       String
  logo            String?
  favicon         String?
  theme           Json     // BrandTheme
  domain          String?
  subdomain       String?
  sslEnabled      Boolean  @default(true)
  regionPricing   Json?
  customColors    Json?
  customFonts     Json?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([domain])
  @@index([subdomain])
  @@map("brand_configs")
}

model PartnerAuditLog {
  id              String   @id @default(uuid())
  partnerId       String
  userId          String
  action          String   // create | update | delete | suspend | activate | payment | payout
  resource        String
  resourceId      String?
  changes         Json?
  ipAddress       String?
  userAgent       String?
  timestamp       DateTime @default(now())

  // Relations
  partner         Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("partner_audit_logs")
}

// Phase 8.3: Enterprise Enhancements

model Webhook {
  id              String   @id @default(uuid())
  userId          String?
  partnerId       String?
  url             String
  events          String[] // WebhookEventType[]
  secret          String?
  active          Boolean  @default(true)
  retries         Int      @default(3)
  timeout         Int      @default(30000)
  headers         Json?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  deliveries      WebhookDelivery[]

  @@index([userId])
  @@index([partnerId])
  @@index([active])
  @@map("webhooks")
}

model WebhookDelivery {
  id              String   @id @default(uuid())
  webhookId       String
  event           Json     // WebhookEvent
  status          String   // pending | delivered | failed
  attempts        Int      @default(0)
  responseCode    Int?
  responseBody    String?  @db.Text
  deliveredAt     DateTime?
  failedAt        DateTime?
  error           String?  @db.Text
  createdAt       DateTime @default(now())

  // Relations
  webhook         Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

model TaxRate {
  id              String   @id @default(uuid())
  region          String   // EU | US | CA | UK | AU | SG | IN | OTHER
  country         String
  state           String?
  type            String   // vat | gst | sales_tax | custom
  rate            Float    // Percentage
  name            String
  description     String?  @db.Text
  effectiveFrom   DateTime @default(now())
  effectiveTo     DateTime?
  isActive        Boolean  @default(true)

  @@index([country])
  @@index([state])
  @@index([type])
  @@index([isActive])
  @@map("tax_rates")
}

model TaxExemption {
  id              String   @id @default(uuid())
  userId          String
  country         String
  reason          String   @db.Text
  taxNumber       String?
  validFrom       DateTime @default(now())
  validTo         DateTime?
  isActive        Boolean  @default(true)

  @@index([userId])
  @@index([country])
  @@index([isActive])
  @@map("tax_exemptions")
}

model Refund {
  id              String   @id @default(uuid())
  invoiceId       String
  userId          String
  subscriptionId  String?
  amount          Float
  currency        String   @default("USD")
  type            String   // full | partial | prorated
  reason          String   // customer_request | duplicate_charge | fraudulent | service_issue | billing_error | other
  status          String   @default("pending") // pending | processing | completed | failed | cancelled
  description     String?  @db.Text
  paymentProvider String   // stripe | paypal | crypto
  paymentIntentId String?
  refundId        String?
  processedAt     DateTime?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  disputes        Dispute[]

  @@index([invoiceId])
  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
  @@map("refunds")
}

model Dispute {
  id              String   @id @default(uuid())
  refundId        String
  userId          String
  reason          String   @db.Text
  evidence        String[]
  status          String   @default("open") // open | under_review | resolved | closed
  resolution      String?  @db.Text
  createdAt       DateTime @default(now())
  resolvedAt      DateTime?

  // Relations
  refund          Refund   @relation(fields: [refundId], references: [id], onDelete: Cascade)

  @@index([refundId])
  @@index([userId])
  @@index([status])
  @@map("disputes")
}

model SLADefinition {
  id              String   @id @default(uuid())
  tier            String   // free | pro | enterprise | custom
  name            String
  uptimeTarget    Float    // Percentage
  latencyTarget    Float    // Milliseconds
  throughputTarget Float    // Requests per second
  errorRateTarget  Float    // Percentage
  description     String?  @db.Text
  isActive        Boolean  @default(true)

  @@index([tier])
  @@index([isActive])
  @@map("sla_definitions")
}

model SLAMetrics {
  id              String   @id @default(uuid())
  subscriptionId  String
  userId          String
  tier            String
  periodStart     DateTime
  periodEnd       DateTime
  uptime          Float    // Percentage
  latency         Float    // Average milliseconds
  throughput      Float    // Requests per second
  errorRate       Float    // Percentage
  status          String   // met | at_risk | breached
  breaches        Int      @default(0)
  lastChecked     DateTime @default(now())

  @@unique([subscriptionId, periodStart])
  @@index([subscriptionId])
  @@index([userId])
  @@index([status])
  @@map("sla_metrics")
}

model SLAAlert {
  id              String   @id @default(uuid())
  subscriptionId  String
  userId          String
  metric          String   // uptime | latency | throughput | error_rate
  currentValue    Float
  targetValue     Float
  severity        String   // warning | critical
  status          String   @default("open") // open | acknowledged | resolved
  createdAt       DateTime @default(now())
  resolvedAt      DateTime?

  @@index([subscriptionId])
  @@index([userId])
  @@index([status])
  @@index([severity])
  @@map("sla_alerts")
}

model CurrencyConfig {
  id                String   @id @default(uuid())
  userId            String?
  partnerId         String?
  defaultCurrency   String   @default("USD")
  supportedCurrencies String[] // Currency[]
  autoConvert       Boolean  @default(true)
  metadata          Json?

  @@unique([userId])
  @@unique([partnerId])
  @@map("currency_configs")
}

model IPWhitelist {
  id              String   @id @default(uuid())
  userId          String
  ip              String
  description     String?  @db.Text
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([isActive])
  @@map("ip_whitelists")
}

model GeoBlockRule {
  id              String   @id @default(uuid())
  userId          String?
  partnerId       String?
  country         String
  action          String   // allow | block | require_verification
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([partnerId])
  @@index([country])
  @@index([isActive])
  @@map("geo_block_rules")
}

model SecurityAuditLog {
  id              String   @id @default(uuid())
  userId          String?
  ip              String
  country         String?
  action          String
  resource        String
  status          String   // success | failed | blocked
  reason          String?  @db.Text
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([ip])
  @@index([action])
  @@index([status])
  @@index([createdAt])
  @@map("security_audit_logs")
}

model TwoFactorAuth {
  id              String   @id @default(uuid())
  userId          String   @unique
  totpEnabled     Boolean  @default(false)
  totpSecret      String?
  smsEnabled      Boolean  @default(false)
  smsPhoneNumber  String?
  emailEnabled    Boolean  @default(false)
  backupCodes     String[]
  createdAt       DateTime @default(now())
  verifiedAt      DateTime?

  @@index([userId])
  @@map("two_factor_auth")
}

// Phase 8.4: Developer Marketplace & AI Runtime

model Developer {
  id                String   @id @default(uuid())
  userId            String   @unique
  email             String
  name              String
  company           String?
  status            String   @default("pending") // pending | verified | suspended | rejected
  verificationLevel String   @default("email") // email | kyc | full
  tier              String   @default("free") // free | pro | enterprise
  walletId          String   @unique
  profile           Json     // DeveloperProfile
  portfolio         Json     // DeveloperPortfolio
  kycData           Json?    // KYCData
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  apps              App[]
  wallet            DeveloperWallet?
  withdrawals       Withdrawal[]

  @@index([userId])
  @@index([status])
  @@index([verificationLevel])
  @@map("developers")
}

model App {
  id              String   @id @default(uuid())
  developerId     String
  name            String
  slug            String   @unique
  description     String   @db.Text
  longDescription String?  @db.Text
  category        String
  tags            String[]
  version         String   @default("1.0.0")
  status          String   @default("draft") // draft | pending | reviewing | approved | rejected | published | suspended
  accessLevel     String   @default("private") // public | private | premium | enterprise
  licenseType     String   @default("closed_source") // open_source | closed_source | commercial | custom
  pricing         Json     // Pricing
  sourceCode      String?  @db.Text
  repository      String?
  icon            String?
  screenshots     String[]
  video           String?
  documentation  String?  @db.Text
  requirements    String[]
  features        String[]
  changelog       String?  @db.Text
  licenseKey      String?
  usageTokens     Int?
  totalDownloads Int      @default(0)
  totalRevenue    Float    @default(0)
  rating          Float    @default(0)
  reviews         Int      @default(0)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  // Relations
  developer       Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)
  versions        AppVersion[]
  installations   AppInstallation[]
  appReviews      AppReview[]
  revenueShares   RevenueShare[]
  scanResults     CodeScanResult[]

  @@index([developerId])
  @@index([status])
  @@index([category])
  @@index([slug])
  @@map("apps")
}

model AppVersion {
  id              String   @id @default(uuid())
  appId           String
  version         String
  status          String   @default("draft") // draft | published | deprecated | archived
  compatibility   String   @default("backward_compatible") // backward_compatible | breaking | major | minor | patch
  changelog       String?  @db.Text
  sourceCode      String   @db.Text
  runtimeConfig   Json?
  apiTokens       String[]
  endpoints       String[]
  isStable        Boolean  @default(false)
  isDefault        Boolean  @default(false)
  createdAt       DateTime @default(now())
  publishedAt     DateTime?
  deprecatedAt    DateTime?

  // Relations
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  appTokens       AppToken[]

  @@unique([appId, version])
  @@index([appId])
  @@index([status])
  @@map("app_versions")
}

model AppToken {
  id                String   @id @default(uuid())
  appId             String
  version           String
  token             String   @unique
  name              String
  permissions       String[]
  rateLimit         Json     // RateLimit
  isActive          Boolean  @default(true)
  expiresAt         DateTime?
  createdAt         DateTime @default(now())

  // Relations
  appVersion        AppVersion @relation(fields: [appId, version], references: [appId, version], onDelete: Cascade)

  @@index([appId])
  @@index([token])
  @@index([isActive])
  @@map("app_tokens")
}

model AppInstance {
  id              String   @id @default(uuid())
  appId           String
  developerId     String
  version         String
  status          String   @default("pending") // pending | running | stopped | error
  containerId     String?
  runtimeConfig   Json     // RuntimeConfig
  resourceUsage   Json     // ResourceUsage
  endpoint        String   @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  metrics         RuntimeMetrics[]

  @@index([appId])
  @@index([developerId])
  @@index([status])
  @@map("app_instances")
}

model RuntimeMetrics {
  id              String   @id @default(uuid())
  instanceId     String
  cpu             Float
  memory          Float
  storage         Float
  requests        Int      @default(0)
  errors          Int      @default(0)
  latency         Float
  uptime          Int
  timestamp       DateTime @default(now())

  // Relations
  instance       AppInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([timestamp])
  @@map("runtime_metrics")
}

model DeveloperWallet {
  id              String   @id @default(uuid())
  developerId     String   @unique
  balance         Float    @default(0)
  currency        String   @default("USD")
  pendingBalance  Float    @default(0)
  totalEarned     Float    @default(0)
  totalWithdrawn  Float    @default(0)
  lastUpdated     DateTime @default(now())

  // Relations
  developer       Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)

  @@index([developerId])
  @@map("developer_wallets")
}

model RevenueShare {
  id                String   @id @default(uuid())
  transactionId     String
  appId             String
  developerId       String
  userId            String
  amount            Float
  currency          String   @default("USD")
  developerShare    Float
  platformShare     Float
  developerPercentage Float
  platformPercentage Float
  type              String   // subscription | one_time | usage | commission
  status            String   @default("pending") // pending | processing | completed | failed
  processedAt       DateTime?
  metadata          Json?
  createdAt         DateTime @default(now())

  // Relations
  app               App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([developerId])
  @@index([status])
  @@index([createdAt])
  @@map("revenue_shares")
}

model Withdrawal {
  id              String   @id @default(uuid())
  developerId     String
  amount          Float
  currency        String   @default("USD")
  walletAddress   String?
  bankAccount     String?
  paymentMethod   String   // crypto | bank | paypal | stripe
  status          String   @default("pending") // pending | processing | completed | failed
  processedAt     DateTime?
  transactionHash String?
  createdAt       DateTime @default(now())

  // Relations
  developer       Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)

  @@index([developerId])
  @@index([status])
  @@index([createdAt])
  @@map("withdrawals")
}

model CodeScanResult {
  id              String   @id @default(uuid())
  appId           String
  version         String
  status          String   @default("pending") // pending | scanning | completed | failed
  riskLevel       String   @default("low") // low | medium | high | critical
  issues          Json     // ScanIssue[]
  score           Int      // 0-100
  metadata        Json?
  scannedAt       DateTime @default(now())

  // Relations
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([version])
  @@index([riskLevel])
  @@map("code_scan_results")
}

model SecurityAudit {
  id              String   @id @default(uuid())
  appId           String
  developerId     String
  action          String   // publish | update | delete | approve | reject
  scanResultId    String?
  riskLevel       String   @default("low") // low | medium | high | critical
  approved        Boolean  @default(false)
  approvedBy      String?
  notes           String?  @db.Text
  createdAt       DateTime @default(now())

  @@index([appId])
  @@index([developerId])
  @@index([action])
  @@index([createdAt])
  @@map("security_audits")
}

model AppReview {
  id              String   @id @default(uuid())
  appId           String
  userId          String
  rating          Int      // 1-5
  title           String?
  comment         String?  @db.Text
  status          String   @default("pending") // pending | approved | rejected
  helpful         Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([userId])
  @@index([status])
  @@index([rating])
  @@map("app_reviews")
}

model AppInstallation {
  id              String   @id @default(uuid())
  appId           String
  userId          String
  version         String
  instanceId      String?
  status          String   @default("installed") // installed | running | stopped | uninstalled
  installedAt     DateTime @default(now())
  lastUsedAt      DateTime?

  // Relations
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([userId])
  @@index([status])
  @@map("app_installations")
}


// Phase 8.5: Matrix Intelligence Federation & Internal Economy

model AIIdentity {
  id              String   @id @default(uuid())
  type            String   // intelligence | app | service | agent
  name            String
  description     String?  @db.Text
  token           String   @unique
  publicKey       String
  capabilities    String[]
  endpoint        String?
  metadata        Json?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([token])
  @@index([isActive])
  @@map("ai_identities")
}


// Phase 8.5: Matrix Intelligence Federation & Internal Economy

model AIIdentity {
  id              String   @id @default(uuid())
  type            String   // intelligence | app | service | agent
  name            String
  description     String?  @db.Text
  token           String   @unique
  publicKey       String
  capabilities    String[]
  endpoint        String?
  metadata        Json?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([token])
  @@index([isActive])
  @@map("ai_identities")
}

model AICommunication {
  id              String   @id @default(uuid())
  fromAI          String
  toAI            String
  message         String   @db.Text
  payload         Json
  status          String   // pending | active | completed | failed
  response        Json?
  timestamp       DateTime @default(now())

  @@index([fromAI])
  @@index([toAI])
  @@index([status])
  @@map("ai_communications")
}

model ServiceRequest {
  id              String   @id @default(uuid())
  requesterAI     String
  providerAI      String
  service         String
  parameters      Json
  status          String   // pending | processing | completed | failed | rejected
  cost            Float?
  currency        String?
  result          Json?
  error           String?  @db.Text
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([requesterAI])
  @@index([providerAI])
  @@index([status])
  @@map("service_requests")
}

model DependencyRelation {
  id              String   @id @default(uuid())
  fromAI          String
  toAI            String
  service         String
  isRequired      Boolean  @default(true)
  priority        Int      @default(1)
  createdAt       DateTime @default(now())

  @@index([fromAI])
  @@index([toAI])
  @@map("dependency_relations")
}

model MatrixCoinWallet {
  id              String   @id @default(uuid())
  accountId       String   @unique
  accountType     String   // user | developer | ai | app | system
  balance         Float    @default(0)
  lockedBalance   Float    @default(0)
  totalEarned     Float    @default(0)
  totalSpent      Float    @default(0)
  lastUpdated     DateTime @default(now())

  @@index([accountId])
  @@index([accountType])
  @@map("matrix_coin_wallets")
}

model MatrixCoinTransaction {
  id              String   @id @default(uuid())
  fromAccountId   String
  fromAccountType String
  toAccountId     String
  toAccountType   String
  amount          Float
  currency        String   @default("MXC")
  type            String   // transfer | payment | reward | fee | conversion | mint | burn
  status          String   @default("pending") // pending | processing | completed | failed | reversed
  description     String?  @db.Text
  metadata        Json?
  blockHash       String?
  transactionHash String?
  createdAt       DateTime @default(now())
  processedAt     DateTime?

  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("matrix_coin_transactions")
}

model CurrencyConversion {
  id              String   @id @default(uuid())
  accountId       String
  fromCurrency    String
  toCurrency      String
  fromAmount      Float
  toAmount        Float
  exchangeRate    Float
  fee             Float
  status          String   // pending | processing | completed | failed
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([accountId])
  @@index([status])
  @@map("currency_conversions")
}

model AIContract {
  id              String   @id @default(uuid())
  fromAI          String
  toAI            String
  type            String   // service | payment | data | computation
  service         String
  description     String   @db.Text
  price           Float
  currency        String   @default("MXC")
  duration        Int?     // seconds
  conditions      Json     // ContractCondition[]
  status          String   @default("active") // active | completed | failed | cancelled
  result          Json?
  error           String?  @db.Text
  metadata        Json?
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([fromAI])
  @@index([toAI])
  @@index([status])
  @@index([type])
  @@map("ai_contracts")
}

model LedgerEntry {
  id              String   @id @default(uuid())
  type            String   // ai_contract | transaction | conversion
  entityId        String
  action          String
  data            Json
  timestamp       DateTime @default(now())

  @@index([type])
  @@index([entityId])
  @@index([timestamp])
  @@map("ledger_entries")
}

model AppAICall {
  id              String   @id @default(uuid())
  appId           String
  aiId            String
  service         String
  input           Json
  output          Json?
  cost            Float
  currency        String   @default("MXC")
  status          String   @default("pending") // pending | processing | completed | failed
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([appId])
  @@index([aiId])
  @@index([status])
  @@map("app_ai_calls")
}

model AIReputation {
  id              String   @id @default(uuid())
  aiId            String   @unique
  rating          Float    @default(5.0) // 0-5
  accuracy        Float    @default(100) // 0-100
  performance     Float    @default(100) // 0-100
  userSatisfaction Float   @default(100) // 0-100
  totalCalls      Int      @default(0)
  successfulCalls Int      @default(0)
  failedCalls     Int      @default(0)
  averageLatency  Float    @default(0) // milliseconds
  rank            Int      @default(0)
  status          String   @default("active") // active | suspended | deprecated
  lastUpdated     DateTime @default(now())

  @@index([aiId])
  @@index([rank])
  @@index([status])
  @@map("ai_reputations")
}
