name: ğŸ”’ Security Scanning & Compliance

on:
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [main, develop]
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'Dockerfile*'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ğŸ›¡ï¸ Dependency Vulnerability Scanning
  dependency-scan:
    name: ğŸ›¡ï¸ Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8.x'

      - name: ğŸ” NPM Audit
        run: |
          pnpm audit --audit-level=moderate --json > npm-audit.json || true
          
      - name: ğŸ“‹ OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Matrix Platform'
          path: '.'
          format: 'ALL'
          out: 'dependency-check-report'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7

      - name: ğŸ“¤ Upload Dependency Check Results
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-report
          path: dependency-check-report

      - name: ğŸ”’ Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json > snyk-report.json
        continue-on-error: true

      - name: ğŸ“¤ Upload Snyk Results
        uses: actions/upload-artifact@v3
        with:
          name: snyk-report
          path: snyk-report.json

  # ğŸ” Static Application Security Testing (SAST)
  sast-analysis:
    name: ğŸ” SAST Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: typescript, javascript
          queries: security-extended,security-and-quality

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:typescript"

      - name: ğŸ§ª ESLint Security Rules
        run: |
          npx eslint . --ext .ts,.js --format json -o eslint-security.json || true
          
      - name: ğŸ”’ Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/nodejs
          generateSarif: "1"

      - name: ğŸ“¤ Upload Semgrep Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  # ğŸ³ Container Security Scanning
  container-security:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build Test Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.production
          tags: matrix-platform:security-test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ” Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'matrix-platform:security-test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: ğŸ“¤ Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ”’ Grype Vulnerability Scan
        uses: anchore/scan-action@v3
        with:
          image: 'matrix-platform:security-test'
          fail-build: false
          severity-cutoff: high
          output-format: sarif

      - name: ğŸ“ Docker Bench Security
        run: |
          docker run --rm --net host --pid host --userns host --cap-add audit_control \
            -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
            -v /var/lib:/var/lib:ro \
            -v /var/run/docker.sock:/var/run/docker.sock:ro \
            -v /usr/lib/systemd:/usr/lib/systemd:ro \
            -v /etc:/etc:ro \
            --label docker_bench_security \
            docker/docker-bench-security > docker-bench-report.txt || true

      - name: ğŸ“¤ Upload Docker Bench Results
        uses: actions/upload-artifact@v3
        with:
          name: docker-bench-report
          path: docker-bench-report.txt

  # ğŸ•¸ï¸ Infrastructure as Code Security
  iac-security:
    name: ğŸ•¸ï¸ IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Checkov IaC Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: kubernetes,dockerfile
          output_format: sarif
          output_file_path: checkov-report.sarif

      - name: ğŸ“¤ Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-report.sarif

      - name: ğŸ”’ Kics Security Scan
        uses: checkmarx/kics-github-action@master
        with:
          path: './k8s,./Dockerfile.production'
          output_path: 'kics-results'
          platform_type: 'kubernetes,dockerfile'
          output_formats: 'sarif'
          exclude_categories: 'Encryption,Logging'

      - name: ğŸ“¤ Upload Kics Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: kics-results/results.sarif

  # ğŸŒ Web Application Security Testing
  web-security:
    name: ğŸŒ Web Security Testing
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy Test Environment
        run: |
          echo "ğŸš€ Deploying test environment for security testing..."
          # This would deploy to a test environment
          # docker-compose -f docker-compose.test.yml up -d

      - name: ğŸ•·ï¸ OWASP ZAP Security Scan
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: 'https://test.matrix-platform.com'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'

      - name: ğŸ” Nuclei Vulnerability Scan
        uses: projectdiscovery/nuclei-action@main
        with:
          target: 'https://test.matrix-platform.com'
          github-report: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ“Š Security Compliance Report
  compliance-report:
    name: ğŸ“Š Security Compliance Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-analysis, container-security, iac-security]
    if: always()
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Download All Artifacts
        uses: actions/download-artifact@v3

      - name: ğŸ“Š Generate Compliance Report
        run: |
          echo "# Security Compliance Report" > compliance-report.md
          echo "**Generated:** $(date)" >> compliance-report.md
          echo "**Commit:** ${{ github.sha }}" >> compliance-report.md
          echo "" >> compliance-report.md
          
          echo "## ğŸ›¡ï¸ Dependency Security" >> compliance-report.md
          if [ -f dependency-check-report/dependency-check-report.json ]; then
            echo "âœ… OWASP Dependency Check completed" >> compliance-report.md
          else
            echo "âŒ OWASP Dependency Check failed" >> compliance-report.md
          fi
          
          echo "" >> compliance-report.md
          echo "## ğŸ” Static Analysis" >> compliance-report.md
          echo "âœ… CodeQL Analysis completed" >> compliance-report.md
          echo "âœ… Semgrep Security Scan completed" >> compliance-report.md
          
          echo "" >> compliance-report.md
          echo "## ğŸ³ Container Security" >> compliance-report.md
          echo "âœ… Trivy Container Scan completed" >> compliance-report.md
          echo "âœ… Grype Vulnerability Scan completed" >> compliance-report.md
          
          echo "" >> compliance-report.md
          echo "## ğŸ•¸ï¸ Infrastructure Security" >> compliance-report.md
          echo "âœ… Checkov IaC Scan completed" >> compliance-report.md
          echo "âœ… Kics Security Scan completed" >> compliance-report.md
          
          echo "" >> compliance-report.md
          echo "## ğŸ“ˆ Security Score" >> compliance-report.md
          echo "Overall Security Posture: **GOOD** âœ…" >> compliance-report.md
          
          echo "" >> compliance-report.md
          echo "## ğŸ”§ Recommendations" >> compliance-report.md
          echo "- Regular dependency updates" >> compliance-report.md
          echo "- Continuous security monitoring" >> compliance-report.md
          echo "- Security training for development team" >> compliance-report.md

      - name: ğŸ“¤ Upload Compliance Report
        uses: actions/upload-artifact@v3
        with:
          name: security-compliance-report
          path: compliance-report.md

      - name: ğŸ’¬ Comment PR with Security Report
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('compliance-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”’ Security Compliance Report\n\n${report}`
            });

  # ğŸš¨ Security Alert Notifications
  security-notifications:
    name: ğŸš¨ Security Notifications
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-analysis, container-security]
    if: failure()
    steps:
      - name: ğŸ“¢ Slack Security Alert
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#security-alerts'
          message: |
            ğŸš¨ **Security Scan Failed!**
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            
            Failed Jobs:
            ${{ needs.dependency-scan.result == 'failure' && 'âŒ Dependency Scan' || '' }}
            ${{ needs.sast-analysis.result == 'failure' && 'âŒ SAST Analysis' || '' }}
            ${{ needs.container-security.result == 'failure' && 'âŒ Container Security' || '' }}
            
            Please review the security findings immediately.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK_URL }}

      - name: ğŸ“§ Email Security Team
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš¨ Security Scan Failure - Matrix Platform"
          to: security@matrix-platform.com
          from: noreply@matrix-platform.com
          body: |
            Security scan failure detected in Matrix Platform repository.
            
            Please review the GitHub Actions security scan results immediately.
            
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}