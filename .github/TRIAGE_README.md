# CI Triage — how to enable and test

This short guide explains how to test the triage poster and enable automatic posting from GitHub Actions.

Quick overview
- The triage workflow (`.github/workflows/ci-triage.yml`) always uploads `errors.txt` as an artifact when issues are found.
- The poster script `.github/scripts/post-triage-comment-v2.js` will post a comment on the PR when `TRIAGE_POST_TOKEN` (a PAT) is available.
- A safe manual test workflow (`.github/workflows/ci-triage-test.yml`) runs the poster in DRY_RUN so you can preview the comment without posting.

Enable automatic posting (safe steps)
1. Create a Personal Access Token (PAT) on GitHub with minimal scopes:
   - public repositories: `public_repo`
   - private repositories: `repo`

2. Add the PAT as a repository secret named `TRIAGE_POST_TOKEN`:

   Using the GitHub web UI: Repository → Settings → Secrets and variables → Actions → New repository secret → Name: `TRIAGE_POST_TOKEN` → Value: (paste PAT)

   Or using `gh` on your machine (PowerShell):

   ```powershell
   gh secret set TRIAGE_POST_TOKEN --repo sorooh/matrix-platform
   # you will be prompted to paste the PAT
   ```

Run the dry-run test (safe, no posting)
1. Open the Actions tab → CI - triage poster test → Run workflow → select branch (e.g. `ci/e2e-remote-runner-fix`) → Run.
2. In the workflow logs look for the DRY_RUN output which prints the constructed comment (includes run URL).

Run locally (DRY_RUN)
1. Place an `errors.txt` file next to the repo root containing the triage output.
2. Run the poster script in DRY_RUN:

```powershell
# from repo root
$env:REPO='sorooh/matrix-platform'
$env:PR_NUMBER='123'
$env:DRY_RUN='1'
node .\.github\scripts\post-triage-comment-v2.js .\errors.txt
```

Notes and best practices
- Keep the PAT minimal and rotate it periodically.
- If you prefer not to allow CI to post comments, continue using the local `auto_ci_agent.ps1` which downloads artifacts and posts using your host's authenticated `gh` CLI (already working).
- If you want me to add a scheduled task to run `auto_ci_agent.ps1` persistently on your machine, I can generate a PowerShell snippet to register a Windows Scheduled Task.

Schedule the local triage agent
--------------------------------
If you'd like the local `auto_ci_agent.ps1` to run periodically without manual start, run the helper script included in the repo:

PowerShell (run as the user who should own the task):

```powershell
# adjust path if your agent lives somewhere else
.\n+tools\register_agent_task.ps1 -ScriptPath 'C:\workspace\tools\auto_ci_agent.ps1' -TaskName 'AutoCI-Triage-Agent' -Frequency HOURLY -Interval 1
```

This will register a Scheduled Task named `AutoCI-Triage-Agent` that runs every hour under the current user. To delete the task later:

```powershell
schtasks /Delete /TN AutoCI-Triage-Agent /F
```


If you want any of the following, tell me which and I'll implement it next:
- "Enable posting" — I'll help create the PAT and add the secret (or provide exact commands you run locally).
- "Scheduled agent" — I'll produce a safe Windows Scheduled Task registration snippet for `auto_ci_agent.ps1`.
- "Add lint/test" — I'll add a minimal linter/test job to reduce noise in triage outputs.

---
Generated by the triage automation changes. If anything in the repo layout differs, I can adjust the paths accordingly.

<!-- AUTOTRIGGER: minor doc touch to trigger triage dry-run workflow -->
<!-- CI trigger timestamp: 2025-11-03T00:00:00Z -->
