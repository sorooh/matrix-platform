name: CI - check-sharp-and-worker

on:
  workflow_dispatch:
  push:
    branches: [ ci/e2e-remote-runner-fix, feature/matrix-dashboard ]

jobs:
  check-worker-thumbnail:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system packages (libvips, chromium deps)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential python3 ca-certificates libvips-dev libvips-tools libjpeg-dev libpng-dev wget gnupg fontconfig fonts-liberation libatk-bridge2.0-0 libgtk-3-0 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libpangocairo-1.0-0 libpango-1.0-0
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install backend dependencies
        working-directory: matrix-scaffold/backend
        run: npm install --no-audit --no-fund

      - name: Verify native modules availability (sharp/jimp/puppeteer)
        working-directory: matrix-scaffold/backend
        run: |
          node -e "try{require('sharp'); console.log('sharp: OK')}catch(e){console.log('sharp: MISSING', e && e.message)}"
          node -e "try{require('jimp'); console.log('jimp: OK')}catch(e){console.log('jimp: MISSING', e && e.message)}"
          node -e "try{require('puppeteer'); console.log('puppeteer: OK')}catch(e){console.log('puppeteer: MISSING', e && e.message)}"

      - name: Prepare static test app
        run: |
          mkdir -p matrix-scaffold/static/apps/testapp
          cat > matrix-scaffold/static/apps/testapp/index.html <<'HTML'
          <!doctype html>
          <html>
            <head><meta charset="utf-8"><title>Test App</title></head>
            <body>
              <h1>Snapshot Test App</h1>
              <p id="time">TIME</p>
              <script>document.getElementById('time').textContent = new Date().toString()</script>
            </body>
          </html>
          HTML

      - name: Start static server on :3000
        run: |
          pushd matrix-scaffold/static
          python3 -m http.server 3000 &
          echo $! > /tmp/static_pid
          popd

      - name: Start worker (background)
        env:
          NODE_PATH: ${{ github.workspace }}/matrix-scaffold/backend/node_modules
        run: |
          mkdir -p matrix-scaffold/storage/queue matrix-scaffold/storage/meta
          # start worker with NODE_PATH pointing to backend node_modules so it finds puppeteer/sharp/jimp
          # redirect stdout/stderr to a log file so CI artifacts capture worker output for debugging
          (NODE_PATH=${{ github.workspace }}/matrix-scaffold/backend/node_modules node matrix-scaffold/worker/worker.js > matrix-scaffold/storage/worker.log 2>&1) &
          echo $! > /tmp/worker_pid

      - name: Enqueue snapshot job
        run: |
          id=$(node -e "console.log(require('crypto').randomBytes(8).toString('hex'))")
          meta="{\"id\":\"$id\",\"app\":\"testapp\",\"status\":\"queued\"}"
          echo "$meta" > matrix-scaffold/storage/meta/$id.json
          echo "{\"id\":\"$id\",\"app\":\"testapp\"}" > matrix-scaffold/storage/queue/$id.json
          echo $id > /tmp/snapshot_id

      - name: Wait for worker to process
        run: |
          id=$(cat /tmp/snapshot_id)
          echo "Waiting for snapshot $id"
          for i in $(seq 1 40); do
            if [ -f matrix-scaffold/storage/meta/$id.json ]; then
              status=$(jq -r '.status' matrix-scaffold/storage/meta/$id.json)
              echo "status=$status"
              if [ "$status" = "completed" ] || [ "$status" = "failed" ]; then
                break
              fi
            fi
            sleep 2
          done
          cat matrix-scaffold/storage/meta/$id.json || true

      - name: Upload snapshot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-artifacts
          path: matrix-scaffold/storage

      - name: Cleanup background processes
        run: |
          if [ -f /tmp/worker_pid ]; then kill $(cat /tmp/worker_pid) || true; fi
          if [ -f /tmp/static_pid ]; then kill $(cat /tmp/static_pid) || true; fi
 
